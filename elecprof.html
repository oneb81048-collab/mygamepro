<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professeur Volta 2.0 - Cours & Exercices</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22; /* Orange pour les exercices */
            --user-bg: #3498db;
            --ai-bg: #ecf0f1;
            --quiz-bg: #fff3cd;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f6f7;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
        }

        .main-container {
            width: 100%;
            max-width: 900px;
            background: #fff;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 25px rgba(0,0,0,0.15);
        }

        header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
        }

        .api-setup {
            margin-top: 10px;
            padding: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            display: inline-block;
        }

        #apiKeyInput {
            padding: 5px;
            border-radius: 3px;
            border: none;
            width: 220px;
            font-size: 0.85em;
        }

        #chat-window {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 85%;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--user-bg);
            color: white;
        }

        .message.ai {
            align-self: flex-start;
            background-color: var(--ai-bg);
            border-left: 4px solid var(--primary);
            color: #2c3e50;
        }

        .message.quiz {
            align-self: flex-start;
            background-color: var(--quiz-bg);
            border-left: 4px solid var(--accent);
            color: #5d4037;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
            background: #fafafa;
        }

        textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: none;
            height: 50px;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        button {
            padding: 0 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            height: 100%;
            transition: 0.2s;
        }

        #sendBtn { background-color: var(--primary); color: white; flex: 1; }
        #sendBtn:hover { background-color: #34495e; }

        #quizBtn { background-color: var(--accent); color: white; flex: 1; }
        #quizBtn:hover { background-color: #d35400; }
        
        /* Loading animation */
        .typing { font-style: italic; color: #888; font-size: 0.9em; }

    </style>
</head>
<body>

<div class="main-container">
    <header>
        <h2>⚡ Professeur Volta 2.0</h2>
        <div class="api-setup">
            Clé API Hugging Face : 
            <input type="password" id="apiKeyInput" placeholder="Collez hf_... ici">
        </div>
    </header>

    <div id="chat-window">
        <div class="message ai">
            <strong>Bonjour !</strong> Posez-moi une question sur l'électricité.<br>
            Une fois que j'ai répondu, cliquez sur <strong>"Générer un Exercice"</strong> pour tester votre compréhension immédiate.
        </div>
    </div>

    <div class="input-area">
        <textarea id="userInput" placeholder="Ex: Comment fonctionne un transistor ?"></textarea>
        <div class="btn-group">
            <button id="sendBtn" onclick="handleUserRequest()">Envoyer</button>
            <button id="quizBtn" onclick="generateQuiz()">Générer un Exercice</button>
        </div>
    </div>
</div>

<script>
    const MODEL_ID = "mistralai/Mistral-Nemo-Instruct-2407"; 
    
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const quizBtn = document.getElementById('quizBtn');
    const apiKeyInput = document.getElementById('apiKeyInput');

    // Variable pour se souvenir du sujet de conversation
    let lastContext = "Les bases de l'électricité";

    // Gestion de la clé API (Sauvegarde locale)
    if(localStorage.getItem('hf_api_key')) {
        apiKeyInput.value = localStorage.getItem('hf_api_key');
    }
    apiKeyInput.addEventListener('change', () => localStorage.setItem('hf_api_key', apiKeyInput.value));

    // Gestion Entrée
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleUserRequest();
        }
    });

    async function handleUserRequest() {
        const text = userInput.value.trim();
        if (!text) return;

        lastContext = text; // On mémorise le sujet pour le quiz
        addMessage(text, 'user');
        userInput.value = '';
        
        // Prompt Standard
        const prompt = `Tu es un professeur expert en électricité. Réponds de façon pédagogique, précise et structure ta réponse. Utilise LaTeX ($...$) pour les formules.
        Question : ${text}`;
        
        await callAI(prompt, 'ai');
    }

    async function generateQuiz() {
        if(lastContext === "") {
            alert("Posez d'abord une question pour définir le sujet du quiz !");
            return;
        }

        const topic = lastContext.length > 50 ? "le sujet précédent" : lastContext;
        
        // Prompt Spécial Quiz
        const prompt = `Tu es un examinateur strict mais juste.
        Génère un QCM (Questionnaire à Choix Multiples) de 3 questions sur ce sujet précis : "${topic}".
        
        Format exigé pour chaque question :
        1. La question claire.
        2. Trois options (A, B, C).
        3. Après les choix, mets un bloc "Réponse" caché ou en gras expliquant la bonne réponse.
        
        Sois créatif et piège les erreurs courantes.`;

        addMessage(`<em>Génération d'un exercice sur : "${topic}"...</em>`, 'quiz');
        await callAI(prompt, 'quiz');
    }

    async function callAI(systemPrompt, type) {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
            alert("Clé API manquante !");
            return;
        }

        setLoading(true);

        const formattedPrompt = `<s>[INST] ${systemPrompt} [/INST]`;

        try {
            const response = await fetch(
                `https://api-inference.huggingface.co/models/${MODEL_ID}`,
                {
                    headers: { 
                        Authorization: `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    method: "POST",
                    body: JSON.stringify({
                        inputs: formattedPrompt,
                        parameters: {
                            max_new_tokens: 1500,
                            temperature: 0.7,
                            return_full_text: false
                        }
                    }),
                }
            );

            const data = await response.json();
            
            if (data.error) {
                addMessage("Erreur API : " + data.error, 'ai');
            } else {
                addMessage(data[0].generated_text, type);
            }

        } catch (error) {
            addMessage("Erreur réseau : " + error.message, 'ai');
        }

        setLoading(false);
    }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.classList.add('message', type);
        div.innerHTML = marked.parse(text);
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        if (window.MathJax) MathJax.typesetPromise([div]);
    }

    function setLoading(isLoading) {
        sendBtn.disabled = isLoading;
        quizBtn.disabled = isLoading;
        if(isLoading) {
            document.body.style.cursor = "wait";
        } else {
            document.body.style.cursor = "default";
        }
    }
</script>

</body>
</html>
